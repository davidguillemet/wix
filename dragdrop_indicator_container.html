<html>
<head>
<link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jquerymobile/1.4.5/jquery.mobile.min.css">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui-touch-punch/0.2.3/jquery.ui.touch-punch.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquerymobile/1.4.5/jquery.mobile.min.js"></script>
<style>
	body {
		overflow: hidden;
	}
	.handle {
		position: absolute;
		bottom: 0px;
		right: 0px;
		border: 1px solid black;
		background-color: white;
		cursor: se-resize;
	}
	.selection {
		position: absolute;
		top: 0px;
		left: 0px;
		cursor: pointer;
	}
	.closeButton {
		position: absolute;
		top: 0px;
		right: 0px;
		border: 1px solid black;
		background-color: white;
		cursor: pointer;
	}
	.container {
		position: absolute;
		width: auto;
		height: auto;
		display: none;
	}
	.indicatorContainer {
		position: absolute;
		top: 0;
		left: 0;
		width: 100%;
		height: 100%;
		display: none;
	}
	.close {
		position: absolute;
		right: 0px;
		top: -1px;
		width: 11px;
		height: 11px;
		opacity: 0.5;
	}
	.close:hover {
		opacity: 1;
	}
	.close:before, .close:after {
		position: absolute;
		left: 5px;
		content: ' ';
		height: 12px;
		width: 1px;
		background-color: #333;
	}
	.close:before {
		transform: rotate(45deg);
	}
	.close:after {
		transform: rotate(-45deg);
	}
</style>
<script>
$(document).ready(function() {

	let deviceType = 'desktop';
	let _indicatorsTimer = null;
	
	window.onmessage = (event) => {
		if (event.data) {
			const message = event.data;
			switch (message.action) {
			case "set":
				setImage(message.image);
				break;
			case "add":
				addImage();
				setImage(message.image);
				break;
			case "device":
				deviceType = message.device;
				break
			case "border":
				setBorder(message.property, message.value);
				break
			case "removeAll":
				removeAll();
				break;
			case "export":
				exportProject();
				break;
			case "import":
				importProject(message.data, message.clearBefore);
				break;
			}
		}
	};

	function sendMessage(msg) {
		window.parent.postMessage(msg, "*");
	}
	
	function sendUpdateMessage(count) {
		sendMessage({
			action: "update",
			count: count
		});
	}
			
	function log(msg) {
		$("#log").append("<span>&nbsp;" + msg + "</span>");
	}

	const initialImageWidth = 300;
	const handleSize = 10;
	const containerPadding = 5;
	const borderProperties = [];
	borderProperties['border-color'] = 'white';
	borderProperties['border-width'] = '2px';
	const activeColor = "#66f542";
	const inactiveColor = "#666"

	const shadowSize = 5;
	
	let currentImage = -1;
	let imageResizing = -1;
	let previousDragX = 0;
	let previousDragY = 0;
	
	function getContainerSelector(imageIndex) {
		return `#container${imageIndex}`;
	}
	function getHandleSelector(imageIndex) {
		return `#handle${imageIndex}`;
	}
	function getImageSelector(imageIndex) {
		return `#image${imageIndex}`;
	}
	function getCloseSelector(imageIndex) {
		return `#close${imageIndex}`;
	}
	function getSelectionSelector(imageIndex) {
		return `#selection${imageIndex}`;
	}
	function getIndicatorContainerSelector(imageIndex) {
		return `#indicatorContainer${imageIndex}`;
	}

	function getFreeIndex() {
		let index = 0;
		while ($(getContainerSelector(index)).length > 0) {
			index++;
		}
		return index;
	}
	
	function getImageCount() {
		return $("div[class*='container']").length;
	}

	function getFirstValidIndex() {
		if (getImageCount() === 0) {
			return -1;
		}
		let index = 0;
		while ($(getContainerSelector(index)).length === 0) {
			index++;
		}
		return index;
	}
	
	function hideActiveIndicators() {
		showElement(false, getIndicatorContainerSelector(currentImage));
	}

	function setActiveImage(imageIndex) {
		// Remove all seelctions
		$(".selection").css({
			"background-color": inactiveColor
		})

		$(".container").css({
			"z-index": 0
		})
		
		currentImage = imageIndex;

		if (imageIndex === -1) {
			return;
		}
		
		if (deviceType === 'mobile') {
			// Hide all indicators
			$(".indicatorContainer").css({
				display: "none"
			})
		}
		
		// Set active selection
		$(getSelectionSelector(imageIndex)).css({
			"background-color": activeColor
		});
		$(getContainerSelector(imageIndex)).css({
			"z-index": 10
		});
		if (deviceType === 'mobile') {
			// Show Active indicators for 10 Seconds
			$(getIndicatorContainerSelector(imageIndex)).css({
				display: "block"
			})
			if (_indicatorsTimer !== null) {
				clearTimeout(_indicatorsTimer);
			}
			_indicatorsTimer = setTimeout(hideActiveIndicators, 10000);
		}
	}

	function setBorder(property, value) {
		borderProperties[property] = value;
		$("[id^=image]").css(property, value);
	}
	
	function removeAll() {
		let index = 0;
		while (getImageCount() > 0) {
			if ($(getContainerSelector(index)).length > 0) {
				removeImage(index);
			}
			index++;
		}
		sendUpdateMessage(0);
		currentImage = -1;
	}
		
	function removeImage(imageIndex) {
		const containerSelector = getContainerSelector(imageIndex);
		const imageSelector = getImageSelector(imageIndex);
		const handleSelector = getHandleSelector(imageIndex);
		const closeSelector = getCloseSelector(imageIndex);
		const selectionSelector = getSelectionSelector(imageIndex);
		const indicatorContainerSelector = getIndicatorContainerSelector(imageIndex);
		$(indicatorContainerSelector).off();
		$(handleSelector).off();
		$(closeSelector).off();
		$(selectionSelector).off();
		$(imageSelector).off();
		$(containerSelector).off();
		$(containerSelector).remove();
	}

	function exportProject() {
		const project = {
			version: 1.0,
			images: [],
			containerWidth: $("body").width()
		};
		const imageCount = getImageCount();
		for (let imageIndex = 0; project.images.length < imageCount; imageIndex++) {
			const containerElement = $(getContainerSelector(imageIndex));
			if (containerElement.length === 0) {
				continue;
			}
			
			const imageElment = $(getImageSelector(imageIndex));
			const newImage = {
				url: imageElment.attr("src"),
				position: {
					top: containerElement.position().top,
					left: containerElement.position().left
				},
				width: imageElment.width()
			};
			project.images.push(newImage);
		}
		sendMessage({
			action: "export",
			data: project
		})
	}
	
	function importProject(projectData, clearBefore) {
		
		if (clearBefore === true) {
			removeAll();
		}
		
		const initialWidth = projectData.containerWidth;
		const currentWidth = $("body").width();
		const scale = initialWidth / currentWidth;
		
		for (let imageIndex = 0; imageIndex < projectData.images.length; imageIndex++) {
			const imageData = projectData.images[imageIndex];
			const scaledImageData = {
				...imageData,
				position: {
					top: imageData.position.top / scale,
					left: imageData.position.left / scale
				},
				width: imageData.width / scale
			}
			addImage(scaledImageData);
			setImage(imageData.url);
		}
	}

	function addImage(imageData) {		
		const imageIndex = getFreeIndex();
		const containerId = `container${imageIndex}`;
		const imageId = `image${imageIndex}`;
		const handleId = `handle${imageIndex}`;
		const closeId = `close${imageIndex}`;
		const selectionId = `selection${imageIndex}`;
		const indicatorContainerId = `indicatorContainer${imageIndex}`;
		
		const image = `<img id="${imageId}">`;
		const resizeHandle = `<div class="handle" id="${handleId}"></div>`;
		const closeButton = `<div class="closeButton" id="${closeId}"><div class="close"></div></div>`;
		const selectionIndicator = `<div class="selection" id="${selectionId}"></div>`;
		const indicatorContainer = `<div class="indicatorContainer" id="${indicatorContainerId}">${resizeHandle}${closeButton}${selectionIndicator}</div`;
		
		const newImage = $("body").add(`<div class="container" id="${containerId}">${image}${indicatorContainer}</div>`);
		$("body").append(newImage);

		const containerSelector = getContainerSelector(imageIndex);
		const handleSelector = getHandleSelector(imageIndex);
		const imageSelector = getImageSelector(imageIndex);
		const closeSelector = getCloseSelector(imageIndex);
		const selectionSelector = getSelectionSelector(imageIndex);
		const indicatorContainerSelector = getIndicatorContainerSelector(imageIndex);
		
		// Initialize size and positions
		$(handleSelector).css({
			width: handleSize,
			height: handleSize
		})
		$(closeSelector).css({
			width: handleSize,
			height: handleSize
		})
		$(selectionSelector).css({
			width: handleSize + 2,
			height: handleSize + 2,
			"border-radius": handleSize / 2,
			"background-color": inactiveColor
		})
		$(containerSelector).css("padding", containerPadding + "px");

		// Configure events
		let _lastEventTimestamp;
		if (deviceType === 'mobile') {
			$(`${indicatorContainerSelector}, ${imageSelector}`).on('vclick', function(event) {
				if (event.timeStamp === _lastEventTimestamp) return;
				if (currentImage === imageIndex) {
					toggleElementDisplay(indicatorContainerSelector);
				} else {
					setActiveImage(imageIndex);
				}
				_lastEventTimestamp = event.timeStamp;
			});
		} else {
			$(indicatorContainerSelector).on('click', function() {
				setActiveImage(imageIndex);
			})
			$(containerSelector).on('mouseover', function() {
				showElement(true, indicatorContainerSelector);
			});
			$(containerSelector).on('mousemove', function() {
				showElement(true, indicatorContainerSelector);
			});
			$(containerSelector).on('mouseout', function() {
				if (imageResizing === -1) {			
					showElement(false, indicatorContainerSelector);
				}
			});
		}
		
		$(imageSelector).css({
			"cursor": "move",
			"box-shadow": shadowSize + "px " + shadowSize + "px " + shadowSize + "px #999999",
			"border-width": borderProperties["border-width"],
			"border-color": borderProperties["border-color"],
			"border-style": "solid"
		});
		
		// Handle mousedown
		$(handleSelector).on('vmousedown', function(event) {
			startResize(event, imageIndex);
			// Error In case of mobile:
			// Unable to preventDefault inside passive event listener
			if (deviceType === 'desktop') return false;
		});
		
		// Close image
		$(closeSelector).on('vclick', function(event) {
			removeImage(imageIndex);
			sendUpdateMessage(getImageCount());
			// Update currentImage
			if (currentImage === imageIndex) {
				setActiveImage(getFirstValidIndex());
			}
		})
		
		// Set image as active
		$(selectionSelector).on('vclick', function(event) {
			setActiveImage(imageIndex);
		})
	
		// Drag options
	    $(containerSelector).draggable({
			handle: `${indicatorContainerSelector}, ${imageSelector}`,
			cancel: handleSelector,
			containment: "parent"
	    });

		let imageWidth;
		let imageTop, imageLeft;
		if (imageData == null) {
			const availableWidth = $("body").width();
			// the initial width is a third of the available width
			imageWidth = availableWidth / 3;
			imageLeft = (availableWidth - imageWidth) / 2;
			// the initial top is a 5th of the available height
			const availableHeight = $("body").height();
			imageTop = availableHeight / 5;
		} else {
			imageWidth = imageData.width;
			imageLeft = imageData.position.left;
			imageTop = imageData.position.top;
		}
		$(imageSelector).css({
			width: imageWidth
		})
		$(containerSelector).css({
			top: imageTop,
			left: imageLeft,
			display: "block"
		});

		setActiveImage(imageIndex);
		sendUpdateMessage(getImageCount());
	}
	
	function setImage(imageUrl) {
		if (currentImage === -1) {
			addImage();
		}
		$(getImageSelector(currentImage)).attr("src", imageUrl);
	}

	function showElement(show, elementSelector) {
		const element = $(elementSelector);
		const display = element.css('display');
		element.css("display", show === true ? "block" : "none");
	}
		
	function toggleElementDisplay(selector) {
		const element = $(selector);
		const display = element.css('display');
		if (display === 'block') {
			element.css('display', 'none');
		} else {
			element.css('display', 'block');
		}
	}

	function startResize(event, imageIndex) {
		imageResizing = imageIndex;
		$("body").css("cursor", "se-resize");
		previousDragX = event.pageX;
		previousDragY = event.pageY;
	}

	function resizeAll() {
		const currentFrameWidth = $("body").width();
		const scale = initialFrameWidth / currentFrameWidth;
		const animationDuration = 200;
		
		const imageCount = getImageCount();
		let resizeCount = 0;
		for (let imageIndex = 0; resizeCount < imageCount; imageIndex++) {
			const containerSelector = getContainerSelector(imageIndex);
			const containerElement = $(containerSelector);
			if (containerElement.length === 0) {
				continue;
			}
			
			const imageSelector = getImageSelector(imageIndex)
			const currentImagePosition = $(containerElement).position();
	
			$(imageSelector).animate({
				width: $(imageSelector).width()  / scale
			}, animationDuration)
			$(containerSelector).animate({
				top: currentImagePosition.top / scale,
				left: currentImagePosition.left / scale
			}, animationDuration);
			
			resizeCount++;
		}
		initialFrameWidth = currentFrameWidth;
	}

	$("body").on('vmousemove', function(event) {
		if (imageResizing >= 0) {
			const deltaX = event.pageX - previousDragX;
			const deltaY = event.pageY - previousDragY;

			const element = $(getImageSelector(imageResizing));
			const elementWidth = element.width();
			element.css({
				width: elementWidth + deltaX
			});
			
			previousDragX = event.pageX;
			previousDragY = event.pageY;
		}
	});

	$("body").on('vmouseup', function() {
		if (imageResizing >= 0) {
			if (deviceType === 'desktop') {
				showElement(false, getIndicatorContainerSelector(imageResizing));
				$(this).css("cursor", "default");
			}
			imageResizing = -1;
		}
	});
	
	let initialFrameWidth = $("body").width();
	let resizeTimer = null;
	$(window).resize(function () {
		// don't call resizeAll each time...
		if (resizeTimer !== null) {
			clearTimeout(resizeTimer);
		}
		resizeTimer = setTimeout(resizeAll, 200);
	});

	// Remove jQuery mobile background color 
	$("body, body div:first-child").css({ "background-color" : "transparent" });	

	sendMessage({
		action: 'ready'
	})
});
</script>
</head>
<body>

<p id="log" style="color: black; word-break: break-all"></p>

</body>
</html>